<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mealtime</title>
    <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet" 
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
    crossorigin="anonymous"
    >
</head>
<style>
    #map {
        width: 50%;
        height: 100vh;
    }
    #sidebar {
        padding: 16px;
    }
    #wheel{
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0,0,0,0.3);
        display: none;
    }
    #canvas{
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        display: none;
    }
    #restaurant-buttons {
        display: flex;
        flex-direction: column;
        position: absolute;
        right: 0;
        top: 0;
        padding: 10px;
        z-index: 10;
    }
    .restaurant-type {
        margin-bottom: 8px;
        writing-mode: vertical-rl;
        text-orientation: upright;
    }
    .pac-container {
        z-index: 10000;
    }
</style>

</head>
<body style="margin:0">
    <div style="display: flex">
        <div id="map"></div>
        <div id="sidebar">
            <h3>åƒä»€éº¼?</h3>
            <input id="search-input" class="form-control" placeholder="æœå°‹é¤å»³..."/>
            <button class="btn btn-primary mt-2" id="add">åŠ å…¥åˆ—è¡¨</button>
            <button class="btn btn-primary mt-2" id="add1">åŠ å…¥å…¨éƒ¨</button>
            <h4 class="mt-4">æŠ½é¸åˆ—è¡¨</h4>
            <ul class="list-group list-group-flush list-group-numbered" id="restaurant-list"></ul>
            <button id="draw" class="btn btn-success mt-2">æŠ½ç±¤</button>
            <div id="wheel"></div>
            <canvas id="canvas" width="600" height="600"></canvas>
            <div id="restaurant-buttons">
                <button class="btn btn-secondary restaurant-type" data-type="chinese restaurant">ä¸­å¼</button>
                <button class="btn btn-secondary restaurant-type" data-type="japanese restaurant">æ—¥å¼</button>
                <button class="btn btn-secondary restaurant-type" data-type="hot pot restaurant">ç«é‹</button>
                <button class="btn btn-secondary restaurant-type" data-type="curry restaurant">å’–å“©</button>
                <button class="btn btn-secondary restaurant-type" data-type="fast food restaurant">å¿«é¤</button>
                <button class="btn btn-secondary restaurant-type" data-type="barbecue restaurant">ç‡’çƒ¤</button>
            </div>
        </div>
    </div>
    <script src="./Winwheel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.3/TweenMax.min.js"></script>
    <script>
        let map;
        let currentPosition;
        let selectedRestaurant;
        let marker;
        let infoWindow;
        let currentType = null;
        let typeMarkers = [];
        let markedPlaces = [];
        let Place, AdvancedMarkerElement;
 
        async function initMap(){ 
            // è¼‰å…¥å¿…è¦çš„ libraries
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement: AME } = await google.maps.importLibrary("marker");
            const { Place: PlaceClass } = await google.maps.importLibrary("places");
            
            AdvancedMarkerElement = AME;
            Place = PlaceClass;

            map = new Map(document.getElementById('map'), {
                center: {lat: 23.553118, lng: 121.0211024},
                zoom: 7,
                mapId: 'DEMO_MAP_ID'  // æ–°ç‰ˆ API éœ€è¦ mapId
            });
    
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async function (position) {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
        
                    map.setCenter(currentPosition);
                    map.setZoom(16);
        
                    // ä½¿ç”¨èˆŠç‰ˆ Autocomplete (å› ç‚ºæ–°ç‰ˆçš„ Web Component æ•´åˆè¼ƒè¤‡é›œ)
                    const autocomplete = new google.maps.places.Autocomplete(
                        document.getElementById('search-input'),
                        {
                            types: ['restaurant'],
                            bounds: {
                                east: currentPosition.lng + 0.01,
                                west: currentPosition.lng - 0.01,
                                south: currentPosition.lat - 0.01,
                                north: currentPosition.lat + 0.01,
                            },
                            strictBounds: false,
                        }
                    );
        
                    autocomplete.addListener('place_changed', async function() {
                        const place = autocomplete.getPlace();

                        if (!place.geometry || !place.geometry.location) {
                            alert("æ‰¾ä¸åˆ°è©²é¤å»³çš„ä½ç½®è³‡è¨Š");
                            return;
                        }
        
                        selectedRestaurant = {
                            location: {
                                lat: place.geometry.location.lat(),
                                lng: place.geometry.location.lng()
                            },
                            placeId: place.place_id,
                            name: place.name,
                            address: place.formatted_address,
                            phoneNumber: place.formatted_phone_number,
                            rating: place.rating,
                        };
                        
                        map.setCenter(place.geometry.location);
        
                        if(marker) {
                            marker.map = null;
                        }
        
                        marker = new AdvancedMarkerElement({
                            map: map,
                            position: place.geometry.location,
                            title: selectedRestaurant.name
                        });

                        if(!infoWindow){
                            infoWindow = new google.maps.InfoWindow();
                        }

                        infoWindow.setContent(
                            `
                            <h3>${selectedRestaurant.name}</h3>
                            <div>åœ°å€:${selectedRestaurant.address}</div>
                            <div>é›»è©±:${selectedRestaurant.phoneNumber || 'ç„¡'}</div>
                            <div>è©•åˆ†:${selectedRestaurant.rating || 'ç„¡'}</div>
                            `
                        );
                        infoWindow.open({
                            anchor: marker,
                            map: map
                        });
                    });

                    // é¡¯ç¤ºä½¿ç”¨è€…ä½ç½®æ¨™è¨˜
                    new AdvancedMarkerElement({
                        map: map,
                        position: currentPosition,
                        title: "You are here!"
                    });
                });
            }
        }
    
        function clearTypeMarkers() {
            typeMarkers.forEach(marker => {
                marker.map = null;
            });
            typeMarkers = [];
        }
    
        async function searchRestaurants(keyword) {
            if (!currentPosition) {
                alert('æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®,è«‹ç¨å¾Œå†è©¦');
                return;
            }

            console.log('é–‹å§‹æœå°‹:', keyword);

            try {
                // ä½¿ç”¨æ–°ç‰ˆ Place.searchByText
                const request = {
                    textQuery: keyword + ' near me',  // åŠ ä¸Š near me æé«˜ç²¾æº–åº¦
                    fields: ['displayName', 'location', 'rating', 'formattedAddress', 'internationalPhoneNumber', 'id'],
                    locationBias: {
                        center: currentPosition,
                        radius: 2000
                    },
                    maxResultCount: 20,
                    language: 'zh-TW',
                    includedType: 'restaurant'  // é™å®šç‚ºé¤å»³é¡å‹
                };

                const { places } = await Place.searchByText(request);
                
                if (!places || places.length === 0) {
                    alert('é™„è¿‘æ²’æœ‰æ‰¾åˆ°ç›¸é—œé¤å»³,è«‹è©¦è©¦å…¶ä»–é¡åˆ¥');
                    return;
                }

                console.log('æ‰¾åˆ°é¤å»³æ•¸é‡:', places.length);
                
                // æ¸…ç©ºèˆŠè³‡æ–™
                markedPlaces = [];
                clearTypeMarkers();

                // è™•ç†æ¯å€‹é¤å»³
                for (const place of places) {
                    const marker = new AdvancedMarkerElement({
                        map: map,
                        position: place.location,
                        title: place.displayName
                    });
                    
                    typeMarkers.push(marker);

                    // é»æ“Šæ¨™è¨˜é¡¯ç¤ºè³‡è¨Š
                    marker.addListener('click', () => {
                        if(!infoWindow) {
                            infoWindow = new google.maps.InfoWindow();
                        }

                        infoWindow.setContent(
                            `
                            <h3>${place.displayName}</h3>
                            <div>åœ°å€: ${place.formattedAddress || 'ç„¡åœ°å€è³‡è¨Š'}</div>
                            <div>è©•åˆ†: ${place.rating || 'ç„¡è©•åˆ†'}</div>
                            `
                        );
                        infoWindow.open({
                            anchor: marker,
                            map: map
                        });
                    });

                    // å°‡é¤å»³è³‡æ–™åŠ å…¥åˆ—è¡¨
                    markedPlaces.push({
                        name: place.displayName,
                        placeId: place.id,
                        phoneNumber: place.internationalPhoneNumber,
                        address: place.formattedAddress,
                        rating: place.rating,
                        location: {
                            lat: place.location.lat,
                            lng: place.location.lng
                        }
                    });
                }

                console.log('å·²æ¨™è¨˜é¤å»³:', markedPlaces.length);
                alert(`æ‰¾åˆ° ${markedPlaces.length} é–“é¤å»³`);

            } catch (error) {
                console.error('æœå°‹éŒ¯èª¤:', error);
                
                if (error.message && error.message.includes('PERMISSION_DENIED')) {
                    alert('âŒ Places API (New) å°šæœªå•Ÿç”¨\n\nè«‹åˆ° Google Cloud Console å•Ÿç”¨:\n1. æœå°‹ "Places API (New)"\n2. é»æ“Šå•Ÿç”¨\n3. ç­‰å¾… 2-5 åˆ†é˜');
                } else {
                    alert('æœå°‹é¤å»³æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                }
            }
        }

        // é¤å»³é¡åˆ¥æŒ‰éˆ•
        document.querySelectorAll('.restaurant-type').forEach(button => {
            button.addEventListener('click', function () {
                const type = this.getAttribute('data-type');
                
                console.log('é»æ“ŠæŒ‰éˆ•:', type);
                
                if (currentType === type) {
                    clearTypeMarkers();
                    markedPlaces = [];
                    currentType = null;
                } else {
                    clearTypeMarkers();
                    currentType = type;
                    searchRestaurants(type);
                }
            });
        });
    
        // è¼‰å…¥å·²å„²å­˜çš„é¤å»³åˆ—è¡¨
        const restaurantList = JSON.parse(localStorage.getItem('restaurantList')) || [];
        
        restaurantList.forEach(function(restaurant){
            if (restaurant && restaurant.name) {
                document.getElementById('restaurant-list').innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 10px;">${restaurant.name}</span>
                        <button class="btn-close remove"></button>
                    </li>
                `;
            }
        });

        const colors = ['#eae56f','#89f26e','#7de6ef','#e7706f'];
        
        let wheel = new Winwheel({
            numSegments: restaurantList.length || 1,
            segments: restaurantList.length > 0 ? restaurantList.map((restaurant, index) => {
                if (restaurant && restaurant.name) {
                    return{
                        fillStyle: colors[index % 4],
                        text: restaurant.name,
                        strokeStyle: 'white',
                    }
                }
            }) : [{
                fillStyle: colors[0],
                text: 'è«‹åŠ å…¥é¤å»³',
                strokeStyle: 'white',
            }],
        
            pins: true,
            animation: {
                type: 'spinToStop',
                spins: 16,
                easing: 'Power4.easeInOut',

                callbackFinished: async function (segment){
                    document.getElementById('canvas').style.display = 'none';
                    document.getElementById('wheel').style.display = 'none';
                    wheel.rotationAngle = 0;
                    wheel.draw();
                    
                    // æ‰¾åˆ°æŠ½ä¸­çš„é¤å»³
                    const restaurantList = JSON.parse(localStorage.getItem('restaurantList')) || [];
                    const selectedRestaurant = restaurantList.find(r => r.name === segment.text);
                    
                    if (selectedRestaurant && selectedRestaurant.location) {
                        window.alert('ğŸ‰ æŠ½ä¸­: ' + segment.text);
                        
                        // é¡¯ç¤ºåœ¨åœ°åœ–ä¸Š
                        const location = new google.maps.LatLng(
                            selectedRestaurant.location.lat,
                            selectedRestaurant.location.lng
                        );
                        map.setCenter(location);
                        map.setZoom(17);
                        
                        // æ¸…é™¤èˆŠæ¨™è¨˜
                        if(marker) {
                            marker.map = null;
                        }
                        
                        // å‰µå»ºæ–°æ¨™è¨˜
                        marker = new AdvancedMarkerElement({
                            map: map,
                            position: location,
                            title: selectedRestaurant.name
                        });
                        
                        // é¡¯ç¤ºè³‡è¨Šè¦–çª—
                        if(!infoWindow){
                            infoWindow = new google.maps.InfoWindow();
                        }
                        
                        infoWindow.setContent(
                            `
                            <h3>${selectedRestaurant.name}</h3>
                            <div>åœ°å€: ${selectedRestaurant.address || 'ç„¡'}</div>
                            <div>é›»è©±: ${selectedRestaurant.phoneNumber || 'ç„¡'}</div>
                            <div>è©•åˆ†: ${selectedRestaurant.rating || 'ç„¡'}</div>
                            `
                        );
                        infoWindow.open({
                            anchor: marker,
                            map: map
                        });
                        
                        // å°èˆªè·¯ç·š
                        const directionsService = new google.maps.DirectionsService();
                        const directionsRenderer = new google.maps.DirectionsRenderer({
                            map: map,
                            suppressMarkers: true
                        });
                        
                        directionsService.route({
                            origin: currentPosition,
                            destination: location,
                            travelMode: 'WALKING',
                        }, function(response, status) {
                            if (status === 'OK') {
                                directionsRenderer.setDirections(response);
                                const duration = response.routes[0].legs[0].duration.text;
                                alert('æ­¥è¡Œæ™‚é–“: ' + duration);
                            }
                        });
                    } else {
                        window.alert(segment.text);
                    }
                }
            }
        })

        document.getElementById('add').addEventListener('click', function() {
            if (!selectedRestaurant) {
                alert('è«‹å…ˆæœå°‹ä¸¦é¸æ“‡é¤å»³');
                return;
            }

            document.getElementById('restaurant-list').innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 10px;">${selectedRestaurant.name}</span>
                    <button class="btn-close remove"></button>
                </li>
            `;
            
            let restaurantList = JSON.parse(localStorage.getItem('restaurantList')) || [];    
            
            const color = colors[restaurantList.length % 4]
            
            // å¦‚æœè¼ªç›¤åªæœ‰ä¸€å€‹é è¨­é …ç›®ï¼Œå…ˆæ¸…ç©º
            if (wheel.segments.length === 1 && wheel.segments[1].text === 'è«‹åŠ å…¥é¤å»³') {
                wheel = new Winwheel({
                    numSegments: 0,
                    segments: [],
                    pins: true,
                    animation: {
                        type: 'spinToStop',
                        spins: 16,
                        easing: 'Power4.easeInOut',
                        callbackFinished: async function (segment){
                            document.getElementById('canvas').style.display = 'none';
                            document.getElementById('wheel').style.display = 'none';
                            wheel.rotationAngle = 0;
                            wheel.draw();
                            
                            const restaurantList = JSON.parse(localStorage.getItem('restaurantList')) || [];
                            const selectedRestaurant = restaurantList.find(r => r.name === segment.text);
                            
                            if (selectedRestaurant && selectedRestaurant.location) {
                                window.alert('ğŸ‰ æŠ½ä¸­: ' + segment.text);
                                
                                const location = new google.maps.LatLng(
                                    selectedRestaurant.location.lat,
                                    selectedRestaurant.location.lng
                                );
                                map.setCenter(location);
                                map.setZoom(17);
                                
                                if(marker) marker.map = null;
                                
                                marker = new AdvancedMarkerElement({
                                    map: map,
                                    position: location,
                                    title: selectedRestaurant.name
                                });
                                
                                if(!infoWindow) infoWindow = new google.maps.InfoWindow();
                                
                                infoWindow.setContent(
                                    `
                                    <h3>${selectedRestaurant.name}</h3>
                                    <div>åœ°å€: ${selectedRestaurant.address || 'ç„¡'}</div>
                                    <div>é›»è©±: ${selectedRestaurant.phoneNumber || 'ç„¡'}</div>
                                    <div>è©•åˆ†: ${selectedRestaurant.rating || 'ç„¡'}</div>
                                    `
                                );
                                infoWindow.open({anchor: marker, map: map});
                                
                                const directionsService = new google.maps.DirectionsService();
                                const directionsRenderer = new google.maps.DirectionsRenderer({
                                    map: map,
                                    suppressMarkers: true
                                });
                                
                                directionsService.route({
                                    origin: currentPosition,
                                    destination: location,
                                    travelMode: 'WALKING',
                                }, function(response, status) {
                                    if (status === 'OK') {
                                        directionsRenderer.setDirections(response);
                                        const duration = response.routes[0].legs[0].duration.text;
                                        alert('æ­¥è¡Œæ™‚é–“: ' + duration);
                                    }
                                });
                            } else {
                                window.alert(segment.text);
                            }
                        }
                    }
                });
            }
            
            wheel.addSegment({
                fillStyle: color,
                text: selectedRestaurant.name,
                strokeStyle: 'white',
            })

            restaurantList.push(selectedRestaurant);
            localStorage.setItem('restaurantList', JSON.stringify(restaurantList));
        });
           
        document.getElementById('add1').addEventListener('click', function() {
            if (markedPlaces.length === 0) {
                alert('è«‹å…ˆé»é¸é¤å»³é¡åˆ¥æŒ‰éˆ•æœå°‹é¤å»³');
                return;
            }

            let restaurantList = JSON.parse(localStorage.getItem('restaurantList')) || [];
            let addedCount = 0;

            // å¦‚æœè¼ªç›¤åªæœ‰é è¨­é …ç›®ï¼Œé‡å»ºè¼ªç›¤
            if (wheel.segments.length === 1 && wheel.segments[1].text === 'è«‹åŠ å…¥é¤å»³') {
                wheel = new Winwheel({
                    numSegments: 0,
                    segments: [],
                    pins: true,
                    animation: {
                        type: 'spinToStop',
                        spins: 16,
                        easing: 'Power4.easeInOut',
                        callbackFinished: async function (segment){
                            document.getElementById('canvas').style.display = 'none';
                            document.getElementById('wheel').style.display = 'none';
                            wheel.rotationAngle = 0;
                            wheel.draw();
                            
                            const restaurantList = JSON.parse(localStorage.getItem('restaurantList')) || [];
                            const selectedRestaurant = restaurantList.find(r => r.name === segment.text);
                            
                            if (selectedRestaurant && selectedRestaurant.location) {
                                window.alert('ğŸ‰ æŠ½ä¸­: ' + segment.text);
                                
                                const location = new google.maps.LatLng(
                                    selectedRestaurant.location.lat,
                                    selectedRestaurant.location.lng
                                );
                                map.setCenter(location);
                                map.setZoom(17);
                                
                                if(marker) marker.map = null;
                                
                                marker = new AdvancedMarkerElement({
                                    map: map,
                                    position: location,
                                    title: selectedRestaurant.name
                                });
                                
                                if(!infoWindow) infoWindow = new google.maps.InfoWindow();
                                
                                infoWindow.setContent(
                                    `
                                    <h3>${selectedRestaurant.name}</h3>
                                    <div>åœ°å€: ${selectedRestaurant.address || 'ç„¡'}</div>
                                    <div>é›»è©±: ${selectedRestaurant.phoneNumber || 'ç„¡'}</div>
                                    <div>è©•åˆ†: ${selectedRestaurant.rating || 'ç„¡'}</div>
                                    `
                                );
                                infoWindow.open({anchor: marker, map: map});
                                
                                const directionsService = new google.maps.DirectionsService();
                                const directionsRenderer = new google.maps.DirectionsRenderer({
                                    map: map,
                                    suppressMarkers: true
                                });
                                
                                directionsService.route({
                                    origin: currentPosition,
                                    destination: location,
                                    travelMode: 'WALKING',
                                }, function(response, status) {
                                    if (status === 'OK') {
                                        directionsRenderer.setDirections(response);
                                        const duration = response.routes[0].legs[0].duration.text;
                                        alert('æ­¥è¡Œæ™‚é–“: ' + duration);
                                    }
                                });
                            } else {
                                window.alert(segment.text);
                            }
                        }
                    }
                });
            }

            markedPlaces.forEach(place => {
                if (!restaurantList.some(r => r.placeId === place.placeId)) {
                    document.getElementById('restaurant-list').innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 10px;">${place.name}</span>
                            <button class="btn-close remove"></button>
                        </li>
                    `;

                    const color = colors[restaurantList.length % 4];
                    wheel.addSegment({
                        fillStyle: color,
                        text: place.name,
                        strokeStyle: 'white',
                    });

                    restaurantList.push(place);
                    addedCount++;
                }
            });

            localStorage.setItem('restaurantList', JSON.stringify(restaurantList));
            wheel.draw();
            
            if (addedCount > 0) {
                alert(`å·²åŠ å…¥ ${addedCount} é–“é¤å»³`);
            } else {
                alert('é€™äº›é¤å»³éƒ½å·²åœ¨åˆ—è¡¨ä¸­');
            }
        });

        document.getElementById('restaurant-list').addEventListener('click', function(e) {
            if(e.target.classList.contains('remove')){
                e.target.parentNode.remove();
                const restaurantName = e.target.parentNode.innerText.trim();
    
                const restaurantList = JSON.parse(localStorage.getItem('restaurantList')) || [];

                const index = restaurantList.findIndex(function (restaurant) {
                   return restaurant.name === restaurantName; 
                });
                
                if (index !== -1) {
                    wheel.deleteSegment(index + 1);
                    wheel.draw();

                    const newRestaurantList = restaurantList.filter(function(restaurant){
                        if (restaurant && restaurant.name) {
                            if(restaurant.name === restaurantName) return false;
                            return true;
                        }
                    });
        
                    localStorage.setItem('restaurantList', JSON.stringify(newRestaurantList));
                }
            }
        });

        document.getElementById('draw').addEventListener('click', function() {
            const restaurantList = JSON.parse(localStorage.getItem('restaurantList')) || [];
            
            if (restaurantList.length === 0) {
                alert('è«‹å…ˆåŠ å…¥é¤å»³');
                return;
            }

            document.getElementById('wheel').style.display = 'block';
            document.getElementById('canvas').style.display = 'block';
            wheel.startAnimation();
        })

    </script>
    <script 
        async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCp3an_zxqAuxOhq4GKvNkTZKpafqyQZ8s&loading=async&libraries=places,marker&callback=initMap&region=TW&language=zh-TW">
    </script>   
     
</body>
</html>
